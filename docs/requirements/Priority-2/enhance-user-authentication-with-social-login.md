# Priority 2 요구사항 – Social Login 도입 (OAuth2 인증)

## 목적

기존 이메일/비밀번호 기반 인증 시스템에 **Google을 시작으로 다양한 소셜 로그인(OAuth2) 기능을 추가**하여 사용자 접근성을 향상시키고, 향후 Kakao, Naver 등 다른 프로바이더로 확장 가능한 구조를 구축한다.

## 범위

- **포함**: Google OAuth2 로그인, 소셜 계정과 기존 계정 연동, UserIdentity 엔티티 추가, OAuth2 콜백 처리, 신규 사용자 자동 생성, 기존 사용자 소셜 계정 연동, 보안 토큰 발급, 확장 가능한 프로바이더 아키텍처.
- **제외**: 소셜 계정 기반 프로필 동기화, 다중 소셜 계정 간 병합, 소셜 계정 전용 권한 관리, Apple/Facebook/GitHub 로그인 (Priority 3 이상).

## 기능 요구사항

| ID | 제목 | 설명 | 우선순위 |
|----|------|------|----------|
| FR-06a | Google OAuth2 로그인 | 사용자가 Google 계정으로 로그인할 수 있다. | Must |
| FR-06b | UserIdentity 엔티티 | 외부 프로바이더(Google, Kakao 등)의 사용자 ID를 저장하는 엔티티를 추가한다. | Must |
| FR-06c | 신규 사용자 자동 생성 | 처음 소셜 로그인하는 사용자는 자동으로 User 레코드가 생성된다. | Must |
| FR-06d | 기존 계정 연동 | 이메일이 일치하는 기존 계정에 소셜 계정을 연동한다. | Should |
| FR-06e | 소셜 계정 연동 해제 | 사용자가 연동된 소셜 계정을 해제할 수 있다. | Should |
| FR-06f | 다중 프로바이더 지원 | Google 외에도 Kakao, Naver 등 추가 프로바이더를 쉽게 확장할 수 있는 구조를 제공한다. | Must |
| FR-06g | OAuth2 콜백 처리 | OAuth2 인증 후 콜백 URL에서 인증 코드를 처리하고 사용자 정보를 조회한다. | Must |
| FR-06h | 보안 토큰 발급 | 소셜 로그인 성공 시 JWT AccessToken과 RefreshToken을 발급한다. | Must |
| FR-06i | 프로바이더별 사용자 정보 매핑 | 각 프로바이더의 사용자 정보 응답을 User 엔티티로 매핑한다. | Must |

## UX·인터랙션 요구사항

1. **로그인 화면 개선**: 기존 이메일/비밀번호 입력 폼 아래에 "Google로 로그인" 버튼을 추가한다.
2. **소셜 로그인 버튼 디자인**: 각 프로바이더의 공식 브랜드 가이드라인을 준수한다 (Google: "Sign in with Google" 버튼).
3. **자동 리다이렉션**: 소셜 로그인 버튼 클릭 시 OAuth2 인증 페이지로 이동한다.
4. **콜백 처리**: 인증 완료 후 대시보드 또는 이전 페이지로 자동 리다이렉션한다.
5. **계정 연동 알림**: 이메일이 일치하는 기존 계정에 소셜 계정이 연동되었음을 알린다.
6. **에러 처리**: OAuth2 인증 실패 시 명확한 에러 메시지를 표시한다.
7. **설정 화면**: 사용자 프로필 설정에서 연동된 소셜 계정 목록과 연동 해제 버튼을 제공한다.

## 비기능 요구사항

| 항목 | 기준 |
|------|------|
| 성능 | OAuth2 콜백 처리 시간 < 1초, 토큰 발급 시간 < 500ms |
| 신뢰성 | 소셜 로그인 실패 시 기존 이메일/비밀번호 로그인으로 대체 가능 |
| 보안 | OAuth2 state 파라미터로 CSRF 방지, HTTPS 필수, 토큰 탈취 방지 |
| 호환성 | Google OAuth2 2.0 표준 준수, Spring Security OAuth2 Client 사용 |
| 확장성 | 프로바이더 추가 시 최소한의 코드 수정으로 확장 가능 |
| 데이터 무결성 | User ↔ UserIdentity 관계 무결성 보장, 소셜 계정 중복 방지 |

## 가정 및 제약

- 백엔드는 Spring Security OAuth2 Client 라이브러리를 사용한다.
- Google OAuth2 클라이언트 ID와 Secret은 Google Cloud Console에서 발급받아 환경 변수로 관리한다.
- 프론트엔드는 `/api/v1/auth/oauth2/authorization/google` 엔드포인트로 리다이렉션하여 OAuth2 인증을 시작한다.
- 소셜 로그인 시 이메일 정보는 필수로 제공되어야 한다 (프로바이더 설정).
- 기존 User 엔티티의 `password_hash`는 nullable로 변경하여 소셜 로그인 전용 사용자를 지원한다.
- UserIdentity는 User와 1:N 관계로 설정하여 한 사용자가 여러 소셜 계정을 연동할 수 있다.
- 소셜 계정 연동 시 이메일이 일치하면 자동으로 기존 계정에 연동하고, 일치하지 않으면 신규 User를 생성한다.

## 미해결 이슈

1. Kakao, Naver, Apple 로그인의 우선순위 및 구현 일정을 결정해야 한다.
2. 소셜 계정 프로필 정보(이름, 아바타) 동기화 정책을 수립해야 한다.
3. 소셜 계정으로만 가입한 사용자가 이메일/비밀번호를 추가하는 기능 필요 여부를 검토해야 한다.
4. 소셜 계정 연동 해제 시 최소 하나의 인증 수단을 유지하도록 강제할지 결정해야 한다.
5. OAuth2 Access Token 및 Refresh Token을 DB에 저장할지 여부를 검토해야 한다 (현재는 JWT만 발급).
6. 프로바이더별 사용자 정보 API 응답 형식 차이를 어떻게 표준화할지 설계해야 한다.
